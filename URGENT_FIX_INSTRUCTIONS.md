# 🚨 긴급 수정 안내 (2026-01-21 15:00)

## 📸 발견된 문제 (스크린샷 분석 결과)

스크린샷을 분석한 결과 **4가지 심각한 문제**가 발견되었습니다:

### ❌ 문제 1: 시트 열 순서 불일치
```
예상: A열(핸드폰번호) = 010-9988-7766
실제: A열(핸드폰번호) = 2026-01-21 14:50 (타임스탬프가 저장됨!)
```

### ❌ 문제 2: 전화번호 앞자리 0 손실
```
입력: 01099887766 또는 010-9988-7766
저장: 1099887766 (앞자리 0이 사라짐!)
```

### ❌ 문제 3: 기업유형과 추천인 누락
```
C열(기업유형): 비어있음 또는 잘못된 데이터
G열(추천인): 비어있음 또는 잘못된 데이터
```

### ❌ 문제 4: 추천인 검증 미작동
```
입력: "대기중" (사근복컨설턴트 시트에 없는 이름)
결과: 가입 허용됨 (차단되어야 함!)
```

---

## ✅ 해결 방법: Apps Script V5.1 배포

### STEP 1: Google Sheets 준비 (3분)

#### 1-1. 사근복컨설턴트 시트에 테스트 데이터 추가

1. **사근복컨설턴트** 시트 열기
2. 2행에 다음 데이터 입력:
   ```
   A열: 김철수
   B열: 010-1234-5678
   C열: kim@sagunbok.com
   D열: 수석 컨설턴트
   E열: 의료사업부
   F열: 12345
   G열: 서울지사
   H열: 2026-01-20 10:00:00
   ```

#### 1-2. 기업회원 시트 초기화

1. **기업회원** 시트 열기
2. **2행 이하 모두 삭제** (헤더는 유지)
3. A열 전체 선택 → 상단 메뉴 **표시형식** → **일반 텍스트** 선택

#### 1-3. 헤더 확인

**기업회원** 시트 1행이 다음과 같은지 확인:
```
A: 핸드폰번호
B: 회사명
C: 기업유형
D: 이름
E: 이메일
F: 비밀번호
G: 추천인
H: 가입일시
I: 승인상태
J: (비어있음)
K: 마지막로그인
```

---

### STEP 2: Apps Script V5.1 배포 (5분)

#### 2-1. Apps Script 에디터 열기

1. Google Sheets → **확장 프로그램** → **Apps Script**
2. **기존 코드 전체 삭제** (Ctrl+A → Delete)

#### 2-2. V5.1 코드 복사/붙여넣기

1. 아래 파일 열기:
   ```
   /home/user/webapp/docs/apps-script-v5/APPS_SCRIPT_V5.1_EMERGENCY_FIX.js
   ```
2. **전체 복사** (Ctrl+A → Ctrl+C)
3. Apps Script 에디터에 **붙여넣기** (Ctrl+V)
4. **저장** (Ctrl+S)

#### 2-3. 자동 테스트 실행

1. 상단 함수 선택: **runAllTests**
2. **실행** 버튼 클릭 (▶)
3. 권한 승인 (최초 1회만):
   - 고급 → 안전하지 않은 페이지로 이동
   - 권한 허용
4. **실행 로그** 확인:
   ```
   🧪 Sagunbok Apps Script V5.1 자동 테스트 시작
   📱 테스트 1: 전화번호 포맷팅
   ✅ PASS: formatPhone("01012345678") = '010-1234-5678
   ✅ PASS: normalizePhone("010-1234-5678") = 01012345678
   🔎 테스트 2: 추천인 검증 (실패 케이스)
   ✅ PASS: 잘못된 추천인으로 가입 차단됨
   📊 테스트 3: Google Sheets 구조 검증
   ✅ PASS: 필수 시트 존재 확인
   
   📊 테스트 결과:
     ✅ 통과: 3개
     ❌ 실패: 0개
   🎉 모든 테스트 통과! Apps Script가 정상 작동합니다.
   ```

#### 2-4. 웹 앱으로 배포

1. 우측 상단 **배포** → **새 배포**
2. 유형: **웹 앱**
3. 설정:
   - **다음 사용자로 실행**: 나
   - **액세스 권한**: 모든 사용자
4. **배포** 클릭
5. **웹 앱 URL 복사**:
   ```
   https://script.google.com/macros/s/AKfycby.../exec
   ```

---

### STEP 3: 테스트 (10분)

#### 테스트 1: 정상 회원가입 (추천인: 김철수)

**브라우저에서 회원가입 페이지 접속**:
```
http://3.34.186.174
```

**입력 데이터**:
```
회사명: AI테스트병원
기업유형: 병의원개인사업자
담당자 이름: AI테스터
휴대폰 번호: 01099887766
이메일: ai-test@hospital.com
비밀번호: test1234
추천인: 김철수
```

**예상 결과**:
- ✅ "회원가입 신청이 완료되었습니다. 관리자 승인 후 로그인 가능합니다."

**Google Sheets 확인**:
```
A: 010-9988-7766 (하이픈 포함, 앞자리 0 유지!)
B: AI테스트병원
C: 병의원개인사업자 ← 정상 저장!
D: AI테스터
E: ai-test@hospital.com
F: test1234
G: 김철수 ← 정상 저장!
H: 2026-01-21 15:XX:XX
I: 승인전표
J: (비어있음)
K: (비어있음)
```

---

#### 테스트 2: 추천인 검증 실패

**입력 데이터**:
```
추천인: 존재하지않는이름
(나머지는 위와 동일하되 전화번호만 변경: 01099998888)
```

**예상 결과**:
- ❌ "추천인 정보가 올바르지 않습니다. 사근복컨설턴트 명단에 등록된 이름을 입력해주세요."
- ❌ 회원가입 차단

---

#### 테스트 3: 중복 전화번호 차단

**입력 데이터**:
```
전화: 01099887766 (이미 가입된 번호)
추천인: 김철수
(나머지는 다르게 입력)
```

**예상 결과**:
- ❌ "이미 가입된 핸드폰 번호입니다."
- ❌ 회원가입 차단

---

#### 테스트 4: 로그인 (승인 후)

**Google Sheets에서 승인 처리**:
1. 기업회원 시트의 2행 I열(승인상태)을 **`승인완료`**로 변경

**로그인 시도**:
```
전화: 01099887766 (하이픈 없이)
비밀번호: test1234
```

**예상 결과**:
- ✅ 로그인 성공
- ✅ K열(마지막로그인)에 타임스탬프 저장

**하이픈 포함으로 재시도**:
```
전화: 010-9988-7766 (하이픈 포함)
비밀번호: test1234
```

**예상 결과**:
- ✅ 로그인 성공 (하이픈 유무 무관)
- ✅ K열 타임스탬프 업데이트

---

## ✅ 최종 체크리스트

### Google Sheets 준비
- [ ] 사근복컨설턴트 시트에 "김철수" 추가
- [ ] 기업회원 시트의 기존 데이터 삭제
- [ ] A열을 **일반 텍스트** 형식으로 변경
- [ ] 헤더(1행) 확인

### Apps Script V5.1 배포
- [ ] 기존 코드 전체 삭제
- [ ] V5.1 코드 복사/붙여넣기
- [ ] runAllTests 실행 → 모든 테스트 통과
- [ ] 웹 앱으로 배포 → URL 복사

### 테스트
- [ ] 테스트 1: 정상 회원가입 (추천인: 김철수) → 성공
- [ ] Google Sheets 데이터 확인 (A~K열 정상)
- [ ] 테스트 2: 추천인 검증 실패 → 가입 차단
- [ ] 테스트 3: 중복 전화번호 → 가입 차단
- [ ] 테스트 4: 로그인 (하이픈 없이) → 성공
- [ ] 테스트 5: 로그인 (하이픈 포함) → 성공

---

## 📁 관련 파일

| 파일 | 경로 | 설명 |
|------|------|------|
| **V5.1 코드** | `/home/user/webapp/docs/apps-script-v5/APPS_SCRIPT_V5.1_EMERGENCY_FIX.js` | 850줄, 4가지 문제 해결 |
| **배포 가이드** | `/home/user/webapp/docs/apps-script-v5/V5.1_EMERGENCY_FIX_SUMMARY.md` | 상세 설명 |
| **긴급 안내** | `/home/user/webapp/URGENT_FIX_INSTRUCTIONS.md` | 이 파일 |

---

## 🔍 문제 해결

### 문제: 전화번호 앞자리 0이 여전히 사라짐

**원인**: A열이 여전히 숫자 형식  
**해결**: A열 전체 선택 → **표시형식** → **일반 텍스트**

---

### 문제: 추천인 검증이 작동하지 않음

**원인**: 사근복컨설턴트 시트가 비어있음  
**해결**: STEP 1-1 참조하여 "김철수" 추가

---

### 문제: "추천인 정보가 올바르지 않습니다" 메시지가 나옴

**원인**: 추천인 이름 불일치 (공백, 오타 등)  
**해결**: 
1. Apps Script 에디터에서 **실행** → **validateSheetStructure** 실행
2. 로그에서 "등록된 이름" 확인
3. 정확한 이름으로 재시도

---

### 문제: runAllTests에서 테스트 실패

**원인**: 시트 구조 불일치  
**해결**:
1. STEP 1-3 참조하여 헤더 확인
2. 헤더가 정확히 일치하는지 확인 (공백 주의)

---

## 📞 지원

문제가 계속 발생하면 다음 정보를 제공해주세요:
1. Apps Script 실행 로그 (보기 → 로그)
2. Google Sheets 스크린샷
3. 브라우저 콘솔 오류 (F12 → Console)

---

**작성일**: 2026-01-21 15:00  
**버전**: V5.1 (긴급 수정판)  
**커밋**: 9a07b6b  
**상태**: ✅ 배포 준비 완료
