# 📧 **Apps Script v6.2.11 배포 가이드 - 이메일 & 추천인 검증**

## 🎯 **주요 변경사항**

### 1️⃣ **발송자 정보 변경**
- **발송자명**: `TY사근복헬스케어사업단`
- **이메일**: `tysagunbok@gmail.com`

### 2️⃣ **기업회원 가입 시 추천인 검증**
- ✅ **필수**: 추천인 이름 입력 필수
- ✅ **매칭**: 사근복 매니저 또는 컨설턴트 이름과 정확히 일치해야 함
- ❌ **실패**: 등록되지 않은 이름 입력 시 가입 불가
- 📧 **알림**: 추천인에게도 가입 알림 이메일 발송

### 3️⃣ **이메일 발송 흐름**

#### 기업회원 가입 시:
```
1. 회원 → "가입 신청 완료" 이메일
2. 추천인 (매니저/컨설턴트) → "추천 회원 가입" 이메일
3. 관리자 → "새로운 회원 가입 신청" 이메일
```

#### 매니저/컨설턴트 가입 시:
```
1. 회원 → "가입 신청 완료" 이메일
2. 관리자 → "새로운 회원 가입 신청" 이메일
```

#### 대시보드 승인 시:
```
1. 회원 → "승인 완료" 이메일 (로그인 정보 포함)
```

#### 대시보드 거부 시:
```
1. 회원 → "가입 거부" 이메일
```

### 4️⃣ **승인 상태 변경**
- **기존**: 가입 즉시 `'승인'` 상태
- **변경**: 가입 시 `'승인 대기'` 상태로 변경
- **로그인**: 관리자 대시보드에서 승인 후 로그인 가능

---

## 🚀 **배포 방법**

### 1단계: 코드 복사
```bash
cat /home/user/webapp/APPS_SCRIPT_V6.2.11_EMAIL_REFERRER.js
```

### 2단계: Apps Script 에디터
1. https://script.google.com/home
2. 사근복 프로젝트 열기
3. **Ctrl+A** (전체 선택)
4. **Ctrl+V** (새 코드 붙여넣기)
5. **Ctrl+S** (저장)

### 3단계: 배포
1. 우측 상단 **"배포"** → **"배포 관리"**
2. **"수정"** (연필 아이콘)
3. **"버전"** → **"새 버전"**
4. **"설명"**: `v6.2.11 - 이메일 발송 및 추천인 검증 추가`
5. **"배포"** 클릭

### 4단계: 확인
```bash
curl -L 'https://script.google.com/macros/s/AKfycbyULZORS2SzTBYYTK_r_5Kd5Q-I3nELI4RbDim1THqGIX8IT0PiAL-BL2oqomf16ate/exec'
```

**예상 응답**:
```json
{
  "success": true,
  "version": "6.2.11",
  "message": "사근복 AI Apps Script v6.2.11 - 이메일 발송 및 추천인 검증 추가"
}
```

---

## 🧪 **테스트 방법**

### 1️⃣ 이메일 발송 테스트 (Apps Script 에디터에서)

```javascript
// Apps Script 에디터 상단 함수 선택
testEmailSend()  // 실행 버튼 클릭
```

**예상 결과**:
- `tysagunbok@gmail.com`로 테스트 이메일 수신
- 발송자: `TY사근복헬스케어사업단`
- 제목: `[테스트] 사근복 이메일 발송 테스트`

### 2️⃣ 추천인 목록 확인 (Apps Script 에디터에서)

```javascript
// Apps Script 에디터 상단 함수 선택
testReferrerValidation()  // 실행 버튼 클릭
```

**확인 사항**:
- 실행 로그에서 매니저/컨설턴트 이름 목록 확인
- 가입 테스트 시 이 이름을 정확히 입력해야 함

### 3️⃣ 기업회원 가입 테스트 (브라우저)

#### 시나리오 A: 정상 가입 (추천인 있음)
```
1. http://3.34.186.174/ 접속
2. "회원가입" 클릭
3. 기업회원 선택
4. 정보 입력:
   - 회사명: 테스트회사
   - 추천인: [실제 매니저 또는 컨설턴트 이름] ✅
   - 이름, 전화번호, 이메일, 비밀번호 입력
5. "회원가입" 클릭
```

**예상 결과**:
- ✅ "회원가입이 완료되었습니다. 관리자 승인 후 로그인 가능합니다."
- 📧 3개 이메일 발송:
  - 회원: "가입 신청 완료"
  - 추천인: "추천 회원 가입"
  - 관리자: "새로운 회원 가입 신청"

#### 시나리오 B: 가입 실패 (잘못된 추천인)
```
1. 추천인에 존재하지 않는 이름 입력
2. "회원가입" 클릭
```

**예상 결과**:
- ❌ "등록되지 않은 추천인입니다. 사근복 매니저 또는 컨설턴트 이름을 정확히 입력해 주세요."

#### 시나리오 C: 가입 실패 (추천인 미입력)
```
1. 추천인 필드 비워두고 가입 시도
2. "회원가입" 클릭
```

**예상 결과**:
- ❌ "추천인(사근복 매니저 또는 컨설턴트 이름)을 입력해 주세요."

### 4️⃣ 대시보드 승인 테스트

```
1. 관리자 대시보드 로그인 (01063529091 / 12345)
2. "전체" 또는 "기업회원" 탭
3. "승인 대기" 상태의 회원 찾기
4. 상태 드롭다운 → "승인" 선택
```

**예상 결과**:
- ✅ 상태가 "승인"으로 변경
- 📧 회원에게 "승인 완료" 이메일 발송 (로그인 정보 포함)
- 🔐 해당 회원 로그인 가능

### 5️⃣ 이메일 수신 확인

#### 회원 가입 완료 이메일
- **수신자**: 가입한 회원
- **제목**: `[사근복] 기업회원 가입 신청이 완료되었습니다`
- **내용**: 
  - 가입 신청 완료 안내
  - ID (전화번호)
  - 초기 비밀번호: 12345
  - 관리자 승인 대기 안내

#### 추천인 알림 이메일 (기업회원만)
- **수신자**: 추천인 (매니저/컨설턴트)
- **제목**: `[사근복] {추천인}님이 추천한 기업회원 가입 신청`
- **내용**:
  - 회사명
  - 담당자 이름
  - 추천인 정보

#### 관리자 알림 이메일
- **수신자**: tysagunbok@gmail.com
- **제목**: `[사근복] 새로운 기업회원 가입 신청`
- **내용**:
  - 회원 정보 (회사명, 이름, 전화번호, 이메일, 추천인)
  - 관리자 대시보드 링크

#### 승인 완료 이메일
- **수신자**: 승인된 회원
- **제목**: `[사근복] 기업회원 승인 완료`
- **내용**:
  - 승인 완료 안내
  - 로그인 정보 (ID, 비밀번호)
  - 로그인 링크

---

## 📊 **변경 사항 요약**

| 항목 | Before (v6.2.10) | After (v6.2.11) |
|------|------------------|-----------------|
| **발송자명** | 사근복 AI 스튜디오 | TY사근복헬스케어사업단 ✅ |
| **기업회원 추천인** | 선택 | 필수 + 검증 ✅ |
| **가입 시 이메일** | 없음 | 회원, 추천인, 관리자 ✅ |
| **승인 시 이메일** | 없음 | 회원 ✅ |
| **거부 시 이메일** | 없음 | 회원 ✅ |
| **초기 승인 상태** | '승인' | '승인 대기' ✅ |

---

## 🔍 **추천인 검증 로직**

```javascript
// 1. 매니저 시트에서 이름 검색
매니저 시트 → A열(이름) 확인
  ↓
발견 → ✅ 가입 진행 + 추천인 이메일 발송
  ↓
미발견 → 2단계로

// 2. 컨설턴트 시트에서 이름 검색
컨설턴트 시트 → A열(이름) 확인
  ↓
발견 → ✅ 가입 진행 + 추천인 이메일 발송
  ↓
미발견 → ❌ 가입 실패
```

---

## 📝 **중요 사항**

### 1. 이메일 권한
- Apps Script가 Gmail 발송 권한이 필요합니다
- 첫 배포 시 권한 승인 필요

### 2. 추천인 이름 정확성
- **대소문자 구분 없음**
- **공백 포함 정확히 입력**
- 예: "이종근" (O), "이 종근" (X), "이종 근" (X)

### 3. 이메일 발송 실패 시
- 회원가입/승인은 정상 진행
- 로그에만 실패 기록
- 사용자에게 영향 없음

### 4. 테스트 계정
- 기존 계정 (01063529091) 영향 없음
- 새 테스트 계정으로 테스트 권장

---

## 🐛 **문제 해결**

### Q1: 이메일이 발송되지 않아요
```
A1: Apps Script 에디터에서:
1. testEmailSend() 함수 실행
2. 권한 승인 필요 시 승인
3. 로그 확인
4. Gmail Quota 확인 (일일 100통 제한)
```

### Q2: 추천인 검증이 실패해요
```
A2: Apps Script 에디터에서:
1. testReferrerValidation() 함수 실행
2. 로그에서 정확한 이름 확인
3. 가입 시 정확히 동일한 이름 입력
```

### Q3: 이메일은 발송되는데 수신이 안 돼요
```
A3:
1. 스팸 메일함 확인
2. Gmail 필터 확인
3. tysagunbok@gmail.com 발송자 차단 확인
```

---

**배포 후 반드시 테스트하세요!** 🚀

1. ✅ testEmailSend() 실행
2. ✅ testReferrerValidation() 실행
3. ✅ 브라우저에서 회원가입 테스트
4. ✅ 이메일 수신 확인
5. ✅ 대시보드 승인 테스트
