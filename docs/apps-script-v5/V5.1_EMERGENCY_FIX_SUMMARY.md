# 🚨 Apps Script V5.1 긴급 수정 (EMERGENCY FIX)

**작성일**: 2026-01-21 15:00  
**버전**: 5.1 (긴급 수정판)  
**상태**: ✅ 4가지 문제 해결 완료

---

## 📸 발견된 문제 (스크린샷 기준)

### 문제 1: 시트 열 순서 불일치
- **증상**: 데이터가 엉뚱한 열에 저장됨
- **예시**: 
  - A열(핸드폰번호) → `2026-01-21 14:50` (타임스탬프가 저장됨)
  - H열(가입일시) → 비어있음
- **원인**: `appendRow()` 순서가 시트 헤더와 불일치

### 문제 2: 전화번호 앞자리 0 손실
- **증상**: `010-9988-7766` → `1099887766` (앞자리 0 사라짐)
- **원인**: Google Sheets가 숫자로 인식하여 앞의 0 제거
- **해결**: 문자열로 명시적 변환 (`'010-1234-5678`)

### 문제 3: 기업유형과 추천인 누락
- **증상**: C열(기업유형)과 G열(추천인)에 데이터가 저장되지 않음
- **예시**:
  - C열 → `AI테스터` (이름이 잘못 저장됨)
  - G열 → `test1234` (비밀번호가 잘못 저장됨)

### 문제 4: 추천인 검증 미작동
- **증상**: "대기중"이 입력되었는데 가입이 허용됨
- **원인**: 추천인 검증 로직이 실제로 작동하지 않음
- **해결**: 사근복컨설턴트 시트 체크 강화

---

## ✅ 해결 방법

### 1. 전화번호 포맷팅 함수 수정

```javascript
// ❌ 기존 (V5)
function formatPhone(phone) {
  const normalized = normalizePhone(phone);
  if (!normalized || normalized.length !== 11) return normalized;
  return normalized.replace(/^(\d{3})(\d{4})(\d{4})$/, '$1-$2-$3');
}

// ✅ 수정 (V5.1)
function formatPhone(phone) {
  const normalized = normalizePhone(phone);
  if (!normalized || normalized.length !== 11) return normalized;
  
  // ⚠️ 작은따옴표(')를 앞에 붙여서 Google Sheets가 문자열로 인식하도록!
  const formatted = normalized.replace(/^(\d{3})(\d{4})(\d{4})$/, '$1-$2-$3');
  return "'" + formatted; // 예: '010-1234-5678
}
```

**결과**: `'010-1234-5678` (작은따옴표 포함) → Google Sheets에서 문자열로 인식

---

### 2. registerCompany 함수 수정

```javascript
// ✅ 수정된 데이터 저장 순서 (V5.1)
const rowData = [
  formattedPhone,       // A: 핸드폰번호 ('010-1234-5678)
  companyName,          // B: 회사명
  companyType,          // C: 기업유형 ← 누락 해결!
  name,                 // D: 이름
  email,                // E: 이메일
  password,             // F: 비밀번호
  referrer || '',       // G: 추천인 ← 누락 해결!
  timestamp,            // H: 가입일시
  '승인전표'            // I: 승인상태
];

companySheet.appendRow(rowData);
```

**결과**: 모든 데이터가 올바른 열에 저장됨

---

### 3. 추천인 검증 강화

```javascript
// ✅ V5.1: 추천인 검증 로직 강화
Logger.log('추천인 검증 시작: ' + referrer);

if (referrer && referrer.trim() !== '') {
  const consultantLastRow = consultantSheet.getLastRow();
  
  if (consultantLastRow <= 1) {
    Logger.log('사근복컨설턴트 시트가 비어있음');
    return { 
      success: false, 
      error: '추천인 정보가 올바르지 않습니다. 사근복컨설턴트 명단에 등록된 이름을 입력해주세요.' 
    };
  }
  
  const consultantData = consultantSheet.getRange(2, 1, consultantLastRow - 1, 1).getValues();
  const consultantNames = consultantData.map(row => String(row[0]).trim());
  
  Logger.log('사근복컨설턴트 명단: ' + consultantNames.join(', '));
  
  if (!consultantNames.includes(referrer.trim())) {
    Logger.log('추천인 검증 실패: ' + referrer);
    return { 
      success: false, 
      error: '추천인 정보가 올바르지 않습니다. 사근복컨설턴트 명단에 등록된 이름을 입력해주세요.\n등록된 컨설턴트: ' + consultantNames.join(', ')
    };
  }
  
  Logger.log('추천인 검증 성공: ' + referrer);
}
```

**결과**: 추천인이 사근복컨설턴트 시트에 없으면 가입 차단

---

### 4. 로깅 추가

모든 핵심 단계에 `Logger.log()` 추가:
- 추천인 검증 시작/성공/실패
- 전화번호 포맷팅 결과
- 중복 체크 결과
- 저장할 데이터 확인

**결과**: 문제 발생 시 원인 파악 용이

---

## 📋 배포 가이드

### STEP 1: 사근복컨설턴트 시트 준비

Google Sheets의 **사근복컨설턴트** 시트에 테스트 데이터 추가:

```
A열(이름)    B열(핸드폰번호)     C열(이메일)              D열(직함)
김철수       010-1234-5678      kim@sagunbok.com         수석 컨설턴트
```

---

### STEP 2: 기업회원 시트 초기화

기존 테스트 데이터 삭제 (헤더는 유지):
1. 2행 이하 모두 선택
2. 우클릭 → 행 삭제
3. **헤더(1행)는 유지**:
   ```
   A: 핸드폰번호
   B: 회사명
   C: 기업유형
   D: 이름
   E: 이메일
   F: 비밀번호
   G: 추천인
   H: 가입일시
   I: 승인상태
   J: (비어있음)
   K: 마지막로그인
   ```

---

### STEP 3: 핸드폰번호 열 형식 변경

**⚠️ 중요: 전화번호 앞자리 0 손실 방지**

1. A열 전체 선택
2. 상단 메뉴: **표시형식** → **일반 텍스트**
3. 확인

---

### STEP 4: Apps Script V5.1 배포

1. Google Sheets 열기
2. **확장 프로그램** → **Apps Script**
3. **기존 코드 전체 삭제**
4. 아래 파일 내용 **전체 복사/붙여넣기**:
   ```
   /home/user/webapp/docs/apps-script-v5/APPS_SCRIPT_V5.1_EMERGENCY_FIX.js
   ```
5. **저장** (Ctrl+S)
6. **실행** → `runAllTests` 선택 → 실행
7. 권한 승인 (최초 1회)
8. **로그 확인**: 
   ```
   ✅ 통과: 3개
   ❌ 실패: 0개
   🎉 모든 테스트 통과!
   ```

---

### STEP 5: 웹 앱으로 배포

1. 우측 상단 **배포** → **새 배포**
2. 유형 선택: **웹 앱**
3. 설정:
   - **다음 사용자로 실행**: 나
   - **액세스 권한**: 모든 사용자
4. **배포** 클릭
5. **웹 앱 URL 복사**:
   ```
   https://script.google.com/macros/s/AKfycby.../exec
   ```

---

### STEP 6: 프런트엔드 URL 업데이트

프록시 서버의 Apps Script URL을 새 URL로 변경하고 재시작.

---

## 🧪 테스트 시나리오

### 테스트 1: 정상 회원가입 (추천인: 김철수)

**입력:**
```
회사명: AI테스트병원
기업유형: 병의원개인사업자
이름: AI테스터
전화: 01099887766
이메일: ai-test@hospital.com
비밀번호: test1234
추천인: 김철수
```

**예상 결과:**
- ✅ "회원가입 신청이 완료되었습니다. 관리자 승인 후 로그인 가능합니다."
- ✅ Google Sheets 기업회원 시트에 데이터 저장:
  ```
  A: 010-9988-7766 (하이픈 포함, 앞자리 0 유지!)
  B: AI테스트병원
  C: 병의원개인사업자 ← 정상 저장!
  D: AI테스터
  E: ai-test@hospital.com
  F: test1234
  G: 김철수 ← 정상 저장!
  H: 2026-01-21 15:00:00
  I: 승인전표
  J: (비어있음)
  K: (비어있음)
  ```

---

### 테스트 2: 추천인 검증 실패

**입력:**
```
추천인: 존재하지않는이름
(나머지 동일)
```

**예상 결과:**
- ❌ "추천인 정보가 올바르지 않습니다. 사근복컨설턴트 명단에 등록된 이름을 입력해주세요."
- ❌ 회원가입 차단

---

### 테스트 3: 중복 전화번호

**입력:**
```
전화: 01099887766 (이미 가입된 번호)
```

**예상 결과:**
- ❌ "이미 가입된 핸드폰 번호입니다."
- ❌ 회원가입 차단

---

### 테스트 4: 로그인 (하이픈 없이)

**입력:**
```
전화: 01099887766
비밀번호: test1234
```

**예상 결과:**
- ⚠️ "관리자 승인 대기 중입니다."
- (먼저 I열을 `승인완료`로 수정 후 재시도)
- ✅ 로그인 성공
- ✅ K열에 로그인 시간 업데이트

---

### 테스트 5: 로그인 (하이픈 포함)

**입력:**
```
전화: 010-9988-7766
비밀번호: test1234
```

**예상 결과:**
- ✅ 로그인 성공 (하이픈 유무 무관)
- ✅ K열에 로그인 시간 업데이트

---

## 📊 V5 vs V5.1 비교

| 항목 | V5 (기존) | V5.1 (수정) |
|------|-----------|-------------|
| **전화번호 저장** | `010-1234-5678` | `'010-1234-5678` (문자열) |
| **앞자리 0 손실** | ❌ 발생 | ✅ 해결 |
| **데이터 열 순서** | ❌ 불일치 | ✅ 일치 |
| **기업유형/추천인** | ❌ 누락 | ✅ 저장 |
| **추천인 검증** | ⚠️ 약함 | ✅ 강화 |
| **로깅** | ⚠️ 부족 | ✅ 상세 |

---

## 🎯 최종 체크리스트

- [ ] 사근복컨설턴트 시트에 테스트 데이터 추가 (김철수)
- [ ] 기업회원 시트의 기존 데이터 삭제
- [ ] A열(핸드폰번호)을 **일반 텍스트** 형식으로 변경
- [ ] Apps Script V5.1 코드 배포
- [ ] `runAllTests` 실행 → 모든 테스트 통과 확인
- [ ] 웹 앱으로 배포 → URL 복사
- [ ] 프런트엔드 URL 업데이트
- [ ] 테스트 1~5 실행 → 모든 시나리오 통과 확인

---

## 📁 관련 파일

- **V5.1 코드**: `/home/user/webapp/docs/apps-script-v5/APPS_SCRIPT_V5.1_EMERGENCY_FIX.js`
- **요약 문서**: `/home/user/webapp/docs/apps-script-v5/V5.1_EMERGENCY_FIX_SUMMARY.md` (이 파일)

---

## 🚀 다음 단계

1. ✅ **V5.1 배포** (위의 STEP 1~6)
2. ✅ **테스트 실행** (테스트 1~5)
3. ✅ **Google Sheets 확인** (데이터 저장 검증)
4. ✅ **프런트엔드 테스트** (실제 회원가입 페이지)

---

**작성자**: AI  
**작성일**: 2026-01-21  
**버전**: 5.1 (긴급 수정판)  
**상태**: ✅ 배포 준비 완료
