# 🚨 Apps Script V5.2 (최종판) - 시트 구조 변경 대응

**작성일**: 2026-01-21 16:00  
**버전**: V5.2 (FINAL)  
**상태**: ✅ 회원가입 순서에 맞춰 완전히 재작성

---

## 📊 새로운 시트 구조 (회원가입 순서 기준)

### 기업회원 시트
```
A: 가입일시        (yyyy-MM-dd HH:mm:ss)
B: 회사명
C: 기업유형        (개인사업자/법인/병의원개인사업자/의료재단)
D: 이름
E: 핸드폰번호      ('010-1234-5678 형식) ← 중요!
F: 이메일
G: 비밀번호
H: 승인상태        (승인전표/승인완료)
I: 추천인          ← 절대 필수!
J: (비어있음)
K: 마지막로그인
```

---

## 🔧 수정 사항 (V5.1 → V5.2)

### 1. 시트 열 순서 완전히 재배치 ✅
**이전 (V5.1)**:
```
A: 핸드폰번호, B: 회사명, C: 기업유형, D: 이름, E: 이메일...
```

**변경 (V5.2)**:
```
A: 가입일시, B: 회사명, C: 기업유형, D: 이름, E: 핸드폰번호, F: 이메일...
```

**이유**: 프런트엔드 회원가입 폼의 입력 순서와 일치시키기 위함

---

### 2. appendRow 순서 정확히 매칭 ✅

```javascript
// V5.2: 회원가입 순서에 맞춰 데이터 배열 생성
const rowData = [
  timestamp,            // A: 가입일시
  companyName,          // B: 회사명
  companyType,          // C: 기업유형 ← 이제 정상 저장!
  name,                 // D: 이름
  formattedPhone,       // E: 핸드폰번호 ('010-1234-5678)
  email,                // F: 이메일
  password,             // G: 비밀번호
  '승인전표',           // H: 승인상태
  referrer              // I: 추천인 ← 이제 정상 저장!
];

companySheet.appendRow(rowData);
```

---

### 3. 추천인 검증 절대 강화 ✅

```javascript
// ⚠️ 절대 필수: 추천인이 비어있으면 차단
if (!referrer || referrer.trim() === '') {
  Logger.log('❌ 추천인이 비어있음');
  return { 
    success: false, 
    error: '추천인을 반드시 입력해야 합니다.' 
  };
}

// ⚠️ 절대 필수: 사근복컨설턴트 시트와 정확히 매칭
const consultantNames = consultantData.map(row => String(row[0]).trim());

if (!consultantNames.includes(referrer.trim())) {
  Logger.log('❌ 추천인 검증 실패!');
  return { 
    success: false, 
    error: '추천인 정보가 올바르지 않습니다.\n\n사근복컨설턴트 명단에 등록된 이름을 정확히 입력해주세요.\n\n등록된 컨설턴트: ' + consultantNames.join(', ')
  };
}
```

---

### 4. 전화번호 앞자리 0 손실 해결 ✅

```javascript
// E열에 저장 (A열에서 E열로 이동)
formattedPhone = "'010-1234-5678"  // 작은따옴표 포함
```

---

### 5. 로그인 함수 열 매핑 수정 ✅

```javascript
// V5.2: 새로운 열 순서에 맞춰 인덱스 변경
const storedPhone = normalizePhone(row[4]);     // E열 (기존: A열)
const storedPassword = String(row[6]);          // G열 (기존: F열)
const approvalStatus = String(row[7]);          // H열 (기존: I열)
```

---

## 🧪 테스트 체크리스트

### Google Sheets 준비
- [ ] E열(핸드폰번호)을 **일반 텍스트** 형식으로 변경
- [ ] 사근복컨설턴트 시트에 "김철수" 추가
- [ ] 기업회원 시트의 기존 데이터 삭제

### 회원가입 테스트
**입력**:
```
회사명: AI테스트병원
기업유형: 병의원개인사업자
이름: AI테스터
전화: 01099887766
이메일: ai-test@hospital.com
비밀번호: test1234
추천인: 김철수
```

**예상 결과 (Google Sheets)**:
```
A: 2026-01-21 16:XX:XX
B: AI테스트병원
C: 병의원개인사업자      ← 정상 저장!
D: AI테스터
E: 010-9988-7766         ← 하이픈 포함, 0 유지!
F: ai-test@hospital.com
G: test1234
H: 승인전표
I: 김철수                ← 정상 저장!
J: (비어있음)
K: (비어있음)
```

### 추천인 검증 테스트
**입력**: 추천인 "존재하지않는이름"  
**예상**: ❌ "추천인 정보가 올바르지 않습니다..." + 가입 차단

### 중복 전화번호 테스트
**입력**: 전화 `01099887766` (이미 가입됨)  
**예상**: ❌ "이미 가입된 핸드폰 번호입니다." + 가입 차단

---

## 📝 배포 가이드

### STEP 1: Google Sheets 준비
1. E열 전체 선택 → **표시형식** → **일반 텍스트**
2. 사근복컨설턴트 시트에 테스트 데이터 추가:
   ```
   A열: 김철수
   B열: 010-1234-5678
   (나머지 열 채우기)
   ```

### STEP 2: Apps Script V5.2 배포
1. Apps Script 에디터 열기
2. **기존 코드 전체 삭제**
3. V5.2 코드 복사/붙여넣기:
   ```
   /home/user/webapp/docs/apps-script-v5/APPS_SCRIPT_V5.2_FINAL.js
   ```
4. **저장** → **실행** → `runAllTests`
5. **배포** → **새 배포** → **웹 앱** → URL 복사

### STEP 3: 테스트
브라우저에서 http://3.34.186.174 접속 후 회원가입 테스트

---

## 📊 V5.1 vs V5.2 비교

| 항목 | V5.1 | V5.2 |
|------|------|------|
| **시트 구조** | A=핸드폰, B=회사명... | A=가입일시, B=회사명... |
| **전화번호 위치** | A열 | E열 |
| **기업유형 저장** | ❌ 누락 | ✅ C열 정상 |
| **추천인 저장** | ❌ 누락 | ✅ I열 정상 |
| **추천인 검증** | ⚠️ 강화 | ✅ 절대 필수 |
| **로그 상세도** | ⚠️ 보통 | ✅ 매우 상세 |

---

## 🎯 핵심 포인트

### 1. 시트 = 회원가입 순서 기준
모든 데이터 저장 순서를 프런트엔드 폼의 입력 순서와 일치시킴

### 2. 추천인 검증 절대 강화
- 추천인 비어있으면 **무조건 차단**
- 사근복컨설턴트 명단과 **정확히 일치**해야 함
- 검증 실패 시 등록된 컨설턴트 목록 표시

### 3. 상세 로깅
모든 단계마다 `Logger.log()` 추가:
- 추천인 검증 시작/성공/실패
- 등록된 컨설턴트 목록
- 저장할 데이터 확인

---

## 📁 파일 정보

- **V5.2 코드**: `/home/user/webapp/docs/apps-script-v5/APPS_SCRIPT_V5.2_FINAL.js` (790줄)
- **요약 문서**: `/home/user/webapp/docs/apps-script-v5/V5.2_SUMMARY.md` (이 파일)

---

**작성자**: AI  
**작성일**: 2026-01-21 16:00  
**버전**: V5.2 (최종판)  
**상태**: ✅ 회원가입 순서 완벽 매칭
