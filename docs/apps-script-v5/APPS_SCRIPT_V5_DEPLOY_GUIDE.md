# 📦 Sagunbok Apps Script V5 배포 가이드

**작성일**: 2026-01-21  
**버전**: V5 (FINAL)  
**파일**: `/home/user/APPS_SCRIPT_V5_FINAL.js`

---

## 🎯 V5 주요 개선사항 (5가지 요구사항 완료)

### ✅ 1. 시트와 가입 데이터 매칭 로직 수정 (시트 기준)
- **문제**: 스크린샷 기준 데이터 순서가 맞지 않음
- **해결**: `appendRow()` 순서를 시트 헤더와 완벽히 일치시킴
- **시트 구조**:
  ```
  A: 핸드폰번호
  B: 회사명
  C: 기업유형
  D: 이름
  E: 이메일
  F: 비밀번호
  G: 추천인
  H: 가입일시
  I: 승인상태
  J: (비어있음)
  K: 마지막로그인
  ```

### ✅ 2. 핸드폰 번호 형식 고정
- **저장 형식**: `010-1234-5678` (하이픈 포함)
- **로그인 허용**: `010-1234-5678` 또는 `01012345678` 모두 가능
- **함수**: `formatPhone()` (저장용), `normalizePhone()` (비교용)

### ✅ 3. 추천인 검증 강화
- **검증 대상**: 사근복컨설턴트 시트 A열 (이름)
- **불일치 시**: `"추천인 정보가 올바르지 않습니다. 사근복컨설턴트 명단에 등록된 이름을 입력해주세요."`
- **가입 차단**: `success: false` 반환

### ✅ 4. 핸드폰 번호 중복 체크
- **기업회원**: 가입 시 기업회원 시트 A열 전체 검색
- **사근복컨설턴트**: 가입 시 사근복컨설턴트 시트 B열 전체 검색
- **중복 시**: `"이미 가입된 핸드폰 번호입니다."` 반환

### ✅ 5. 자동 기능 테스트 포함
- **테스트 함수**: `runAllTests()` - 전체 기능 자동 검증
- **구조 검증**: `validateSheetStructure()` - 시트 구조 확인
- **실행 방법**: Apps Script 에디터에서 직접 실행 가능

---

## 📋 배포 전 준비사항

### 1. Google Sheets 구조 확인

#### A. 기업회원 시트 헤더 (1행)
```
A: 핸드폰번호
B: 회사명
C: 기업유형
D: 이름
E: 이메일
F: 비밀번호
G: 추천인
H: 가입일시
I: 승인상태
J: (비어있음)
K: 마지막로그인
```

**복사용 (Tab 구분)**:
```
핸드폰번호	회사명	기업유형	이름	이메일	비밀번호	추천인	가입일시	승인상태		마지막로그인
```

#### B. 사근복컨설턴트 시트 헤더 (1행)
```
A: 이름
B: 핸드폰번호
C: 이메일
D: 직함
E: 소속 사업단
F: 비밀번호
G: 소속 지사
H: 가입일시
```

**복사용 (Tab 구분)**:
```
이름	핸드폰번호	이메일	직함	소속 사업단	비밀번호	소속 지사	가입일시
```

#### C. 로그인기록 시트 헤더 (1행)
```
A: 타임스탬프
B: 전화번호
C: 사용자유형
D: 상태
```

**복사용 (Tab 구분)**:
```
타임스탬프	전화번호	사용자유형	상태
```

---

### 2. 테스트용 컨설턴트 데이터 추가

**사근복컨설턴트 시트 > 2행**:
```
김철수	010-9876-5432	kim@sagunbok.com	수석 컨설턴트	의료사업부	12345	서울지사	2026-01-20 10:00:00
```

**복사용 (Tab 구분)**:
```
김철수	010-9876-5432	kim@sagunbok.com	수석 컨설턴트	의료사업부	12345	서울지사	2026-01-20 10:00:00
```

---

## 🚀 배포 단계별 가이드

### STEP 1: Apps Script 에디터 열기

1. Google Sheets 열기 (사근복 프로젝트)
2. 상단 메뉴: **확장 프로그램** → **Apps Script**
3. 새 탭에서 Apps Script 에디터 열림

---

### STEP 2: 기존 코드 삭제 및 V5 코드 복사

1. **기존 코드 전체 선택** (Ctrl+A)
2. **삭제** (Delete)
3. **V5 코드 복사**:
   - 파일: `/home/user/APPS_SCRIPT_V5_FINAL.js`
   - 내용 전체 복사 (Ctrl+C)
4. **Apps Script 에디터에 붙여넣기** (Ctrl+V)
5. **저장** (Ctrl+S 또는 💾 아이콘)

---

### STEP 3: 프로젝트 이름 변경 (선택사항)

- 상단 "제목 없는 프로젝트" 클릭
- 이름 변경: `Sagunbok Auth V5`
- Enter 키

---

### STEP 4: 시트 구조 검증 (자동 테스트)

1. Apps Script 에디터 상단 메뉴: **실행** → **함수 선택**
2. 드롭다운에서 **`validateSheetStructure`** 선택
3. **실행** 버튼 클릭
4. **권한 승인** (최초 1회):
   - "권한 검토" 클릭
   - Google 계정 선택
   - "고급" → "프로젝트로 이동(안전하지 않음)" 클릭
   - "허용" 클릭
5. **로그 확인** (Ctrl+Enter 또는 **보기** → **로그**):
   ```
   📊 Google Sheets 구조 검증
   🏢 기업회원 시트:
   ✅ 시트 존재
   📋 헤더: 
      A열: 핸드폰번호
      B열: 회사명
      ...
   ```

---

### STEP 5: 자동 기능 테스트 실행

1. 함수 선택: **`runAllTests`**
2. **실행** 버튼 클릭
3. **로그 확인** (Ctrl+Enter):
   ```
   🧪 Sagunbok Apps Script V5 자동 테스트 시작
   
   📱 테스트 1: 전화번호 포맷팅
   ✅ PASS: formatPhone("01012345678") = "010-1234-5678"
   ✅ PASS: normalizePhone("010-1234-5678") = "01012345678"
   
   🔍 테스트 2: 추천인 검증 (실패 케이스)
   ✅ PASS: 잘못된 추천인으로 가입 차단됨
   
   🔄 테스트 3: 중복 체크
   ✅ PASS: 중복 전화번호로 가입 차단됨
   
   📊 테스트 결과
   ✅ 통과: 5개
   ❌ 실패: 0개
   ```

---

### STEP 6: 웹 앱으로 배포

1. Apps Script 에디터 상단 우측: **배포** → **새 배포**
2. 설정:
   - **유형 선택**: ⚙️ 아이콘 클릭 → **웹 앱** 선택
   - **설명** (선택사항): `Sagunbok Auth V5`
   - **실행 계정**: **나**
   - **액세스 권한**: **모든 사용자**
3. **배포** 버튼 클릭
4. **웹 앱 URL 복사**:
   ```
   https://script.google.com/macros/s/AKfy...../exec
   ```
5. ⚠️ **이 URL을 잘 보관하세요!** (프론트엔드 설정에 사용)

---

### STEP 7: 프론트엔드 설정 업데이트

1. 서버 접속:
   ```bash
   ssh -i lightsail-key.pem ubuntu@3.34.186.174
   ```

2. proxy-server.js 수정:
   ```bash
   cd /var/www/sagunbok
   sudo nano proxy-server.js
   ```

3. **Apps Script URL 교체**:
   ```javascript
   // 기존
   const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzy2r_92-QqqEkcQP1QjQujAZ9bws3WuVBAol5PjVV8j7tfD-51lnaCk0Z8MxBZej1T/exec';
   
   // 새로운 V5 URL로 교체
   const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_NEW_V5_URL/exec';
   ```

4. 저장 및 종료 (Ctrl+O, Enter, Ctrl+X)

5. PM2 재시작:
   ```bash
   sudo pm2 restart proxy-server
   sudo pm2 save
   ```

---

## ✅ 배포 완료 확인

### 1. 웹 앱 직접 테스트 (GET 요청)

브라우저 주소창:
```
https://script.google.com/macros/s/YOUR_V5_URL/exec?action=test
```

**예상 결과**:
```json
{
  "success": true,
  "message": "Sagunbok Apps Script V5 is running!",
  "timestamp": "2026-01-21T05:30:00.000Z"
}
```

---

### 2. 프록시 서버 헬스 체크

브라우저 또는 curl:
```bash
curl http://3.34.186.174:3001/api/health
```

**예상 결과**:
```json
{
  "status": "ok",
  "message": "Proxy server is running",
  "appsScriptUrl": "https://script.google.com/macros/s/YOUR_V5_URL/exec"
}
```

---

### 3. 프론트엔드 테스트

#### A. 회원가입 테스트
1. URL: http://3.34.186.174
2. **기업회원 가입** 클릭
3. 입력:
   ```
   회사명: 테스트병원
   기업유형: 병의원개인사업자
   이름: 홍길동
   전화번호: 01012347890 (하이픈 없이 입력)
   이메일: test@hospital.com
   비밀번호: test1234
   추천인: 김철수
   ```
4. **가입하기** 클릭

**예상 결과**:
```
✅ 회원가입 신청이 완료되었습니다. 관리자 승인 후 로그인 가능합니다.
```

#### B. Google Sheets 데이터 확인

**기업회원 시트 > 마지막 행**:
```
A: 010-1234-7890        ← 하이픈 포함 저장 ✅
B: 테스트병원
C: 병의원개인사업자
D: 홍길동
E: test@hospital.com
F: test1234
G: 김철수
H: 2026-01-21 14:30:25
I: 승인전표              ← 초기 상태
J: (비어있음)
K: (비어있음)            ← 로그인 전까지 비어있음
```

#### C. 승인 처리

1. **I열** (승인상태) 클릭
2. `승인전표` → `승인완료` 변경
3. Enter 키

#### D. 로그인 테스트 (하이픈 없이)

1. **로그인** 페이지
2. 입력:
   ```
   ID: 01012347890        ← 하이픈 없이
   비밀번호: test1234
   ```
3. **로그인** 클릭

**예상 결과**:
```
✅ 로그인 성공
```

#### E. 로그인 테스트 (하이픈 포함)

1. **로그아웃** (있다면)
2. 입력:
   ```
   ID: 010-1234-7890      ← 하이픈 포함
   비밀번호: test1234
   ```
3. **로그인** 클릭

**예상 결과**:
```
✅ 로그인 성공
```

#### F. 마지막 로그인 시간 확인

**기업회원 시트 > 해당 행 > K열**:
```
K: 2026-01-21 15:00:00   ← 로그인 시간 자동 업데이트 ✅
```

---

## 🧪 추가 테스트 시나리오

### 시나리오 1: 추천인 검증 실패

**입력**:
```
추천인: 존재하지않는컨설턴트
```

**예상 결과**:
```
❌ 추천인 정보가 올바르지 않습니다. 사근복컨설턴트 명단에 등록된 이름을 입력해주세요.
```

---

### 시나리오 2: 중복 전화번호 차단

**입력**:
```
전화번호: 01012347890 (이미 가입된 번호)
```

**예상 결과**:
```
❌ 이미 가입된 핸드폰 번호입니다.
```

---

### 시나리오 3: 승인 전 로그인 시도

**상태**: I열 = `승인전표`

**예상 결과**:
```
❌ 회원가입 승인 대기 중입니다. 관리자 승인 후 로그인해주세요.
```

---

## 🚨 문제 해결 가이드

### Q1. 테스트 실행 시 "권한 없음" 오류

**해결**:
1. Apps Script 에디터: **실행** → **함수 선택** → **`runAllTests`**
2. **실행** 클릭
3. 권한 승인 팝업에서:
   - "고급" 클릭
   - "프로젝트로 이동(안전하지 않음)" 클릭
   - "허용" 클릭

---

### Q2. 회원가입 후 시트에 데이터가 안 들어감

**확인 사항**:
1. Apps Script 배포 설정:
   - **실행 계정**: **나** (본인)
   - **액세스 권한**: **모든 사용자**
2. proxy-server.js의 Apps Script URL이 최신 V5 URL인지 확인
3. PM2 재시작: `sudo pm2 restart proxy-server`

---

### Q3. 로그인 시 "승인 대기" 메시지

**해결**:
1. Google Sheets > 기업회원 시트 열기
2. 해당 행 > I열 (승인상태)
3. `승인전표` → `승인완료` 변경

---

### Q4. 전화번호 형식이 이상함 (하이픈 없이 저장됨)

**원인**: 이전 버전의 Apps Script 사용 중

**해결**:
1. Apps Script 에디터에서 V5 코드 전체 재복사
2. 저장 후 재배포:
   - **배포** → **배포 관리**
   - 기존 배포 **편집**
   - 버전: **새 버전**
   - **배포** 클릭

---

## 📊 V5 vs V4 비교표

| 항목 | V4 (기존) | V5 (최신) |
|------|----------|----------|
| 시트 매핑 | ❌ 불일치 | ✅ 완벽 일치 |
| 전화번호 저장 | 하이픈 없이 | ✅ 010-1234-5678 |
| 로그인 (하이픈 유무) | ✅ 지원 | ✅ 지원 |
| 추천인 검증 | ⚠️ 약함 | ✅ 강화 (가입 차단) |
| 중복 체크 | ⚠️ 약함 | ✅ 강화 (양방향) |
| 자동 테스트 | ❌ 없음 | ✅ 포함 (runAllTests) |
| 구조 검증 | ❌ 없음 | ✅ 포함 (validateSheetStructure) |
| 코드 주석 | ⚠️ 부분적 | ✅ 상세 주석 |

---

## 📝 체크리스트

### 배포 전
- [ ] Google Sheets 헤더 확인 (기업회원, 사근복컨설턴트, 로그인기록)
- [ ] 테스트용 컨설턴트 데이터 추가 (김철수)
- [ ] 기존 잘못된 데이터 삭제 (기업회원 시트 2행 이하)

### 배포 중
- [ ] Apps Script 에디터에 V5 코드 복사
- [ ] 저장 (Ctrl+S)
- [ ] `validateSheetStructure` 실행 → 로그 확인
- [ ] `runAllTests` 실행 → 모든 테스트 통과 확인
- [ ] 웹 앱으로 배포 (실행: 나, 액세스: 모든 사용자)
- [ ] 웹 앱 URL 복사 및 보관

### 배포 후
- [ ] proxy-server.js에 새 V5 URL 업데이트
- [ ] PM2 재시작
- [ ] 웹 앱 직접 테스트 (GET ?action=test)
- [ ] 프록시 헬스 체크
- [ ] 프론트엔드 회원가입 테스트
- [ ] Google Sheets 데이터 확인 (A~K열)
- [ ] 승인 처리 (I열 → 승인완료)
- [ ] 로그인 테스트 (하이픈 유무 2가지)
- [ ] 마지막 로그인 시간 확인 (K열)
- [ ] 추천인 검증 테스트 (잘못된 추천인)
- [ ] 중복 체크 테스트 (같은 전화번호)

---

## 🎉 완료!

모든 체크리스트를 통과했다면 **Apps Script V5가 성공적으로 배포**되었습니다!

---

## 📞 문의 및 지원

- **Apps Script 파일**: `/home/user/APPS_SCRIPT_V5_FINAL.js`
- **배포 가이드**: `/home/user/APPS_SCRIPT_V5_DEPLOY_GUIDE.md`
- **프론트엔드**: http://3.34.186.174
- **프록시 서버**: http://3.34.186.174:3001

---

**작성일**: 2026-01-21  
**버전**: V5 (FINAL)  
**상태**: ✅ 배포 준비 완료
