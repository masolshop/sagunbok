# Google Apps Script 배포 가이드

**작성일**: 2026-01-22  
**대상**: Apps Script 웹 앱 배포

---

## 📋 배포 방법 2가지

### 방법 1: 새 배포 만들기 (추천)
**언제 사용**: 
- ✅ 코드를 크게 변경했을 때
- ✅ 새 버전을 명확히 구분하고 싶을 때
- ✅ URL이 바뀌어도 상관없을 때

### 방법 2: 배포 관리 (기존 URL 유지)
**언제 사용**:
- ✅ **URL을 바꾸고 싶지 않을 때** ⭐ 권장
- ✅ 기존 배포를 업데이트할 때
- ✅ Proxy 서버 설정을 바꾸기 싫을 때

---

## 🎯 권장: 방법 2 (배포 관리 - 기존 URL 유지)

### 단계별 가이드

#### 1단계: Apps Script 에디터 열기

1. **Google Sheets 열기**
   ```
   https://docs.google.com/spreadsheets/d/1NzBVwAjDTSQWznBapoD1fGspUvXpvQsozdJVSEF5Atc/edit
   ```

2. **Apps Script 에디터 열기**
   ```
   상단 메뉴 → 확장 프로그램 → Apps Script
   (또는 도구 → 스크립트 편집기)
   ```

---

#### 2단계: 코드 업데이트

1. **기존 코드 전체 선택**
   ```
   Ctrl + A (Windows/Linux)
   Cmd + A (Mac)
   ```

2. **삭제**
   ```
   Delete 키
   ```

3. **새 코드 붙여넣기**
   - 파일 경로: `/home/user/webapp/google-apps-script-v3-exact-columns.js`
   - 전체 코드 복사
   - Apps Script 에디터에 붙여넣기

4. **저장**
   ```
   Ctrl + S (Windows/Linux)
   Cmd + S (Mac)
   
   또는 상단 아이콘 💾 클릭
   ```

---

#### 3단계: 배포 관리 (기존 URL 유지) ⭐ 권장

1. **배포 메뉴 열기**
   ```
   상단 메뉴 → 배포 → 배포 관리
   ```
   
   **스크린샷 참고**:
   ```
   ┌─────────────────────────────┐
   │ 파일  수정  보기  실행  배포  │
   │              ↓                │
   │         새 배포               │
   │         배포 관리 ← 클릭      │
   │         배포 테스트           │
   └─────────────────────────────┘
   ```

2. **기존 배포 확인**
   ```
   배포 관리 창이 열림
   
   ┌─────────────────────────────────────┐
   │ 활성 배포                            │
   │                                      │
   │ 배포 ID: AKfycby...                 │
   │ 유형: 웹 앱                          │
   │ 설명: (이전 설명)                    │
   │ 버전: 1, 2, 3... ← 버전 목록         │
   │                                      │
   │ [✏️ 편집] 버튼 ← 클릭                │
   └─────────────────────────────────────┘
   ```

3. **편집 버튼 클릭**
   ```
   오른쪽 연필(✏️) 아이콘 클릭
   ```

4. **새 버전 설정**
   ```
   ┌─────────────────────────────────────┐
   │ 새 버전                              │
   │                                      │
   │ 버전: [새 버전 ▼]                    │
   │       ↓                              │
   │       새 버전 ← 선택                  │
   │                                      │
   │ 버전 설명:                            │
   │ [v3.0 - 정확한 컬럼 구조]            │
   │                                      │
   │ 실행: [나 ▼]                         │
   │ 액세스 권한: [모든 사용자 ▼]         │
   │                                      │
   │         [배포]                        │
   └─────────────────────────────────────┘
   ```

5. **버전 설명 입력** (선택사항)
   ```
   v3.0 - 정확한 컬럼 구조
   또는
   로그 시트 분리 업데이트
   ```

6. **배포 버튼 클릭**
   ```
   파란색 [배포] 버튼 클릭
   ```

7. **완료 확인**
   ```
   "배포를 업데이트했습니다" 메시지 표시
   
   ✅ URL은 그대로 유지됨!
   ✅ 코드만 업데이트됨!
   ```

---

#### 4단계: 확인

1. **웹 앱 URL 확인**
   ```
   배포 관리 → 웹 앱 URL 복사
   
   예시:
   https://script.google.com/macros/s/AKfycbyXNblmD7q9iu1Ye91WuU2X2u3iAqi8P-YgG6WaZ-19gPfctqesCS9fQLjQFx9Pv0Go/exec
   
   ↑ 이 URL은 바뀌지 않음!
   ```

2. **테스트**
   ```bash
   # GET 요청 테스트
   curl -s https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec | python3 -m json.tool
   
   # 응답 확인
   {
     "status": "ok",
     "message": "사근복 AI 백엔드 API",
     "version": "3.0 - 정확한 컬럼 구조",  ← 버전 확인
     "timestamp": "2026-01-22T...",
     "sheets": {
       "companies": "기업회원 (10개 컬럼)",
       "consultants": "사근복컨설턴트 (10개 컬럼)",
       "logs": "로그기록 (8개 컬럼)"
     }
   }
   ```

---

## 🆕 방법 1: 새 배포 만들기 (URL 변경됨)

**주의**: 이 방법은 **새로운 URL**이 생성됩니다!

### 단계

1. **배포 메뉴 열기**
   ```
   상단 메뉴 → 배포 → 새 배포
   ```

2. **유형 선택**
   ```
   ⚙️ 유형 선택 (톱니바퀴 아이콘) 클릭
   → "웹 앱" 선택
   ```

3. **설정**
   ```
   설명: v3.0 - 정확한 컬럼 구조
   실행: 나
   액세스 권한: 모든 사용자
   ```

4. **배포 클릭**
   ```
   파란색 [배포] 버튼 클릭
   ```

5. **권한 승인** (처음만)
   ```
   "권한 승인" 클릭
   → Google 계정 선택
   → "고급" 클릭
   → "프로젝트 이름으로 이동(안전하지 않음)" 클릭
   → "허용" 클릭
   ```

6. **새 URL 복사**
   ```
   웹 앱 URL이 표시됨 (새로운 URL!)
   → URL 복사
   ```

7. **Proxy 서버 업데이트 필요!**
   ```bash
   # EC2 SSH 접속
   ssh -i lightsail-key.pem ubuntu@3.34.186.174
   
   # proxy-server.js 편집
   nano /home/ubuntu/proxy-server.js
   
   # BACKEND_URL을 새 URL로 변경
   const BACKEND_URL = '새로운_URL';
   
   # PM2 재시작
   pm2 restart sagunbok-proxy
   ```

---

## 📊 두 방법 비교

| 항목 | 배포 관리 (권장) | 새 배포 |
|------|------------------|---------|
| **URL 변경** | ❌ 유지됨 | ✅ 새 URL 생성 |
| **Proxy 업데이트** | ❌ 불필요 | ✅ 필요 |
| **버전 관리** | ✅ 이전 버전 유지 | ✅ 별도 배포 |
| **롤백 가능** | ✅ 쉬움 | ⚠️ 어려움 |
| **권장 시나리오** | 코드 업데이트 | 완전히 새 프로젝트 |

---

## 🎯 권장 워크플로우

### 일반적인 코드 업데이트

```
1. Apps Script 에디터 열기
   ↓
2. 코드 수정/붙여넣기
   ↓
3. 저장 (Ctrl+S)
   ↓
4. 배포 → 배포 관리
   ↓
5. ✏️ 편집 클릭
   ↓
6. 새 버전 선택
   ↓
7. 배포 클릭
   ↓
8. ✅ 완료 (URL 그대로!)
```

---

## 🔍 배포 버전 확인

### 현재 배포된 버전 확인

```bash
# GET 요청
curl -s https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec | python3 -m json.tool

# version 필드 확인
{
  "version": "3.0 - 정확한 컬럼 구조"  ← 여기서 확인
}
```

---

## 🐛 문제 해결

### 문제 1: "배포 관리"가 안 보임
**원인**: 아직 배포를 한 번도 하지 않음  
**해결**: "새 배포"로 첫 배포 진행

### 문제 2: 코드가 업데이트 안 됨
**원인**: 브라우저 캐시  
**해결**: 
```bash
# EC2에서 테스트
curl -s https://script.google.com/macros/s/YOUR_ID/exec

# 버전 확인
# version 필드가 새 버전인지 확인
```

### 문제 3: 권한 오류
**원인**: 실행 권한 설정 오류  
**해결**:
```
배포 관리 → 편집
→ 실행: "나"
→ 액세스 권한: "모든 사용자"
→ 배포
```

---

## 📚 현재 설정 정보

### 현재 Apps Script 배포 URL
```
https://script.google.com/macros/s/AKfycbyXNblmD7q9iu1Ye91WuU2X2u3iAqi8P-YgG6WaZ-19gPfctqesCS9fQLjQFx9Pv0Go/exec
```

### EC2 Proxy 설정
```javascript
// /home/ubuntu/proxy-server.js
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyXNblmD7q9iu1Ye91WuU2X2u3iAqi8P-YgG6WaZ-19gPfctqesCS9fQLjQFx9Pv0Go/exec';
```

---

## ✅ 체크리스트

### 배포 관리로 업데이트 (권장)
- [ ] 1. Apps Script 에디터 열기
- [ ] 2. 코드 전체 선택 → 삭제
- [ ] 3. 새 코드 붙여넣기
- [ ] 4. 저장 (Ctrl+S)
- [ ] 5. 배포 → 배포 관리
- [ ] 6. ✏️ 편집 클릭
- [ ] 7. "새 버전" 선택
- [ ] 8. 버전 설명 입력 (선택)
- [ ] 9. 배포 클릭
- [ ] 10. GET 요청으로 버전 확인
- [ ] 11. 회원가입/로그인 테스트

### 새 배포 (URL 변경됨)
- [ ] 1. Apps Script 에디터 열기
- [ ] 2. 코드 전체 선택 → 삭제
- [ ] 3. 새 코드 붙여넣기
- [ ] 4. 저장 (Ctrl+S)
- [ ] 5. 배포 → 새 배포
- [ ] 6. 유형: 웹 앱 선택
- [ ] 7. 설명/권한 설정
- [ ] 8. 배포 클릭
- [ ] 9. 새 URL 복사
- [ ] 10. EC2 Proxy 서버 BACKEND_URL 업데이트
- [ ] 11. PM2 재시작
- [ ] 12. 테스트

---

## 🎯 요약

### 🟢 권장: 배포 관리 (기존 URL 유지)
```
배포 → 배포 관리 → ✏️ 편집 → 새 버전 → 배포
↓
✅ URL 그대로!
✅ Proxy 설정 변경 불필요!
✅ 간단!
```

### 🟡 새 배포 (URL 변경됨)
```
배포 → 새 배포 → 설정 → 배포 → 새 URL 복사
↓
⚠️ 새 URL 생성됨
⚠️ Proxy 서버 업데이트 필요
⚠️ PM2 재시작 필요
```

---

**🎉 "배포 관리"로 간단하게 업데이트하세요!**

**핵심**: 
- ✅ **배포 관리** = URL 유지 (권장)
- ⚠️ **새 배포** = 새 URL (Proxy 업데이트 필요)
